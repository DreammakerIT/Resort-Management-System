@model LuxuryResort.Models.BookingViewModel
@{
    ViewData["Title"] = "Xác nhận & Đặt phòng";
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking.css" asp-append-version="true" />
}

<div class="booking-container">
    <div class="booking-header">
        <h1>Xác nhận & Đặt phòng</h1>
        <div class="stepper">
            <div class="step active" data-target="#section-details"><span>1</span> Chi tiết</div>
            <div class="step" data-target="#section-info"><span>2</span> Thông tin</div>
            <div class="step" data-target="#section-payment"><span>3</span> Hoàn tất</div>
        </div>
    </div>

    <form asp-controller="Booking" asp-action="Create" method="post">
        @Html.AntiForgeryToken()
        @if (TempData["PaymentError"] != null)
        {
            <div class="alert alert-danger" role="alert">@TempData["PaymentError"]</div>
        }
        @* This validation summary shows errors not tied to a specific property *@
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        @* Hidden fields to post essential data back to the server *@
        <input type="hidden" asp-for="SelectedRoomId" />

        <div class="booking-grid">
            <div class="left-column">

                <div class="form-section" id="section-details">
                    <h3>Chi tiết kỳ nghỉ của bạn</h3>
                    <div class="form-group">
                        <label>Loại phòng</label>
                        <input type="text" class="form-control" value="@Model.SelectedRoom.Type" readonly />
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ngày nhận phòng</label>
                            <div class="form-control" style="background:#f8f9fa;">@Model.CheckInDate.ToString("dd/MM/yyyy")</div>
                            <input type="hidden" name="CheckInDate" value="@Model.CheckInDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="form-group">
                            <label>Ngày trả phòng</label>
                            <div class="form-control" style="background:#f8f9fa;">@Model.CheckOutDate.ToString("dd/MM/yyyy")</div>
                            <input type="hidden" name="CheckOutDate" value="@Model.CheckOutDate.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Người lớn</label>
                            <div class="form-control" style="background:#f8f9fa;">@Model.Adults</div>
                            <input type="hidden" asp-for="Adults" />
                        </div>
                        <div class="form-group">
                            <label>Trẻ em</label>
                            <div class="form-control" style="background:#f8f9fa;">@Model.Children</div>
                            <input type="hidden" asp-for="Children" />
                        </div>
                    </div>
                </div>

                <div class="form-section" id="section-info">
                    <h3>Thông tin của bạn</h3>
                    <div class="form-group">
                        <label asp-for="FullName">Họ và Tên</label>
                        <input asp-for="FullName" class="form-control" />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label asp-for="Email"></label>
                            <input asp-for="Email" class="form-control" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Phone">Số điện thoại</label>
                            <input asp-for="Phone" class="form-control" />
                            <span asp-validation-for="Phone" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Yêu cầu đặc biệt & Dịch vụ bổ sung</h3>
                    <div class="form-group">
                        <label asp-for="SpecialRequest">Yêu cầu đặc biệt (tùy chọn)</label>
                        <textarea asp-for="SpecialRequest" class="form-control" rows="4" placeholder="Ví dụ: phòng tầng cao..."></textarea>
                    </div>
                </div>

                <div class="form-section" id="section-payment">
                    <h3>Phương thức thanh toán</h3>
                    <div class="payment-options">
                        <label>
                            <input asp-for="PaymentMethod" type="radio" value="vnpay" checked>
                            <span class="payment-option">
                                <strong>VNPay</strong>
                                <small>Thanh toán online qua cổng VNPay</small>
                            </span>
                        </label>
                        <label>
                            <input asp-for="PaymentMethod" type="radio" value="hotel">
                            <span class="payment-option">
                                <strong>Thanh toán tại nơi nghỉ</strong>
                                <small>Thanh toán khi nhận phòng</small>
                            </span>
                        </label>
                    </div>
                    <div id="vnpay-info" class="payment-info">
                        <div class="form-group">
                            <p>Thanh toán nhanh chóng và an toàn qua VNPay. Thẻ ATM nội địa, thẻ tín dụng/ghi nợ hoặc QR.</p>
                        </div>
                    </div>
                    <div id="hotel-info" class="payment-info" style="display: none;">
                        <div class="form-group">
                            <p>Bạn sẽ thanh toán trực tiếp khi nhận phòng tại khách sạn.</p>
                            <div class="hotel-payment-features">
                                <div class="feature-item">
                                    <i class="fas fa-hotel"></i>
                                    <span>Thanh toán tại khách sạn</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-cash-register"></i>
                                    <span>Tiền mặt hoặc thẻ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <p>Bằng việc nhấn nút "Hoàn tất đặt phòng", bạn đồng ý với các <a href="#">Điều khoản & Điều kiện</a>.</p>
                    <button type="submit" class="cta-button">Hoàn Tất Đặt Phòng</button>
                </div>
            </div>

            <div class="right-column">
                <div class="summary-box">
                    <img src="@Model.SelectedRoom.ImageUrl" alt="@Model.SelectedRoom.Type" class="room-image">
                    <div class="summary-content">
                        <h3>@Model.SelectedRoom.Type</h3>
                        <ul class="amenities-list">
                            <li>📏 @Model.SelectedRoom.Area m²</li>
                            <li>🛌 @Model.SelectedRoom.BedType</li>
                            <li>🌊 @Model.SelectedRoom.ViewType</li>
                        </ul>

                        <div class="summary-section">
                            <h4>Tóm tắt kỳ nghỉ</h4>
                            <p><strong>Nhận phòng:</strong> @Model.CheckInDate.ToString("dd/MM/yyyy")</p>
                            <p><strong>Trả phòng:</strong> @Model.CheckOutDate.ToString("dd/MM/yyyy")</p>
                            @{
                                var numberOfNights = (int)(Model.CheckOutDate - Model.CheckInDate).TotalDays;
                                if (numberOfNights <= 0) { numberOfNights = 1; } // Avoid zero or negative nights
                            }
                            <p><strong>Thời gian ở:</strong> @numberOfNights đêm</p>
                            <p><strong>Khách:</strong> @Model.Adults người lớn, @Model.Children trẻ em</p>
                        </div>

                        <div class="summary-section">
                            <h4>Chi tiết chi phí</h4>
                            @{
                                var totalAmount = Model.SelectedRoom.PricePerNight * numberOfNights;
                            }
                            <div class="cost-item">
                                <span>Giá phòng (@numberOfNights đêm)</span>
                                <span>@totalAmount.ToString("N0") ₫</span>
                            </div>
                            <div class="cost-total">
                                <span>Tổng cộng</span>
                                <span>@totalAmount.ToString("N0") ₫</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const paymentRadios = document.querySelectorAll('input[name="PaymentMethod"]');
            const vnpayInfo = document.getElementById('vnpay-info');
            const hotelInfo = document.getElementById('hotel-info');
            const steps = document.querySelectorAll('.stepper .step');

            function togglePaymentInfo() {
                const selectedValue = document.querySelector('input[name="PaymentMethod"]:checked').value;
                
                // Ẩn tất cả thông tin thanh toán
                vnpayInfo.style.display = 'none';
                hotelInfo.style.display = 'none';
                
                // Hiển thị thông tin tương ứng
                if (selectedValue === 'vnpay') {
                    vnpayInfo.style.display = 'block';
                } else if (selectedValue === 'hotel') {
                    hotelInfo.style.display = 'block';
                }
            }

            paymentRadios.forEach(radio => {
                radio.addEventListener('change', togglePaymentInfo);
            });

            // Initial check on page load
            togglePaymentInfo();

            // Smooth scroll to sections when clicking stepper
            steps.forEach(step => {
                step.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    if (!target) return;
                    const el = document.querySelector(target);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        steps.forEach(s => s.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });
        });
    </script>
}